source:
  kind: kafka
  topicPrefix: debezium.mysql.sakila
  topicsExcluded:
  - debezium.mysql.sakila.sakila.__debezium_signals
  - debezium.mysql.sakila.sakila.__debezium_heartbeat
  config:
    bootstrap.servers: kafka:9092
    group.id: alluvial
    key.converter: io.confluent.connect.avro.AvroConverter
    value.converter: io.confluent.connect.avro.AvroConverter
    key.converter.schema.registry.url: http://schema-registry:8081
    value.converter.schema.registry.url: http://schema-registry:8081
    poll.timeout.ms: 1000
  namingAdjusters:
    - class: dev.alluvial.source.kafka.naming.ChangingCaseNamingAdjuster
      case: lower
    - class: dev.alluvial.source.kafka.naming.MappingSchemaNamingAdjuster
      map:
        sakila: dvdrental
        foobar: abcxyz

sink:
  kind: iceberg
  catalog:
    catalog-impl: org.apache.iceberg.hadoop.HadoopCatalog
    warehouse: /tmp/warehouse
    # catalog-impl: org.apache.iceberg.hive.HiveCatalog
    # warehouse: s3a://alluvial/warehouse
    # uri: thrift://hive-metastore:9083
    # io-impl: org.apache.iceberg.aws.s3.S3FileIO
    ## see: org.apache.iceberg.aws.AwsProperties
    # s3.endpoint: http://minio:9000
    # s3.access-key-id: admin   # env.AWS_ACCESS_KEY_ID
    # s3.secret-access-key: SuperSecr3t   # env.AWS_SECRET_ACCESS_KEY
    # client.factory: org.apache.iceberg.aws.AlluvialAwsClientFactory
    ## env.AWS_REGION=aws-global
  tableCreation:
    properties:
      write.format.default: PARQUET
      write.target-file-size-bytes: 134217728  # 128MB
      # engine.hive.enabled: true
    # baseLocation: s3a://alluvial/sakila/
    partitionSpec:
      # Partitioned by column "actor_id" using "void" transformation
      actor:
        - column: actor_id
          transform: void
          name: actor_id_void
      address:
        - column: address_id
          transform: bucket[10]
          name: id_bucket_by_ten
      category:
        - column: name
          transform: truncate[2]
          name: truncated_name
      city:
        - column: country_id
          transform: identity
          name: just_country_id
      film:
        - column: last_update
          transform: month
          name: lum
      film_actor:
        - column: last_update
          transform: day
      payment:
        - column: last_update
          transform: hour
      rental:
        - column: rental_date
          transform: day
      # Partitioned by multiple columns
      customer:
        - column: last_update
          transform: year
          name: p1
        - column: first_name
          transform: truncate[2]
          name: p2
        - column: last_name
          transform: bucket[3]
          name: p3
      # Partitioned by multiple columns using the same transformation
      staff:
        - column: first_name
          transform: truncate[2]
        - column: last_name
          transform: truncate[2]
          name: last_name_trc2

stream:
  kind: debezium
  examineInterval: "3m"
  idleTimeout: "15m"
  commitBatchSize: 1000
  commitTimespan: "10m"

manager:
  namespace: [dvdrental]
  rules:
    tz: "+07"

metrics:
  exporters:
    - kind: prometheus
      properties:
        prometheus.bind: 0.0.0.0:9090
        prometheus.daemon: true
  commonTags:
    environment: "local"
    service: "sakila"
